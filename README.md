# Baremetal F' project

This project was auto-generated by the F' utility tool. 

F´ (F Prime) is a component-driven framework that enables rapid development and deployment of spaceflight and other embedded software applications.
**Please Visit the F´ Website:** https://nasa.github.io/fprime/.


# Setup

### Install arduino-cli
```
$ curl -fsSL https://raw.githubusercontent.com/arduino/arduino-cli/master/install.sh | BINDIR=~/.local/bin sh

```

### Install arduino-cli-wrapper
```
$ cd ~/.local/bin
$ git clone https://github.com/SterlingPeet/arduino-cli-cmake-wrapper.git
$ cd arduino-cli-cmake-wrapper
$ git checkout update/refactor
$ pip install .
```

### Add `~/.local/bin` to PATH
```
$ sudo nano ~/.bashrc
```

At the end of the file, add the following line:
```
export PATH=~/.local/bin:$PATH
```

Save and close the file. Then run:
```
$ source ~/.bashrc
```

### Setup arduino-cli for Teensy boards
```
$ arduino-cli config init
$ sudo nano ~/.arduino15/arduino-cli.yaml
```

Add the following URLs to the `board_manager` section:
```
board_manager:
  additional_urls:
    - https://www.pjrc.com/teensy/package_teensy_index.json
    - https://adafruit.github.io/arduino-board-index/package_adafruit_index.json
```

Download the new board package:
```
$ arduino-cli core update-index
$ arduino-cli core install teensy:avr
$ arduino-cli core install adafruit:samd
```

### Adding udev rules for Linux only
Add udev rules. Save the `.rules` files located in `./docs/rules` into `/etc/udev/rules.d/`.
```
$ sudo cp docs/rules/* /etc/udev/rules.d/
```

## Building and Running the BaremetalReference and RadioPassthrough Applications

In order to build the BaremetalReference and RadioPassthrough Applications, or any other F´ application, we first need to generate a build directory. 
This can be done with the following commands:

```
$ fprime-util generate
```

The next step is to build the RadioPassthrough application's code.
```
$ fprime-util build
```

To generate/build for a specific device, append the device name to the end of the above commands. By default, the application will build for the teensy41 device.
These devices have been tested:
  - teensy41
  - featherM0

## Uploading hex file for the Teensy
The Teensyduino application should have appeared. Choose the appropriate hex file to load into Teensyduino, either BaremetalReference or RadioPassthrough, located in `./build-artifacts/BareMetalReference/bin/` or `./build-artifacts/RadioPassthrough/bin/`, respectively. Manually press the reset button on the Teensy to upload the program.

## Uploading binary file for the Feather M0
Double press on the reset button on the Feather to set it to programming mode. Then run the following commands below for the respective port. There are two binary files: one for the Baremetal Reference and another for the Radio Passthrough. 
```
$ ~/.arduino15/packages/adafruit/tools/bossac/1.8.0-48-gb176eee/bossac -i -d --port=ttyACM0 -U -i --offset=0x2000 -w -v ./build-artifacts/featherM0/RadioPassthrough/bin/RadioPassthrough.bin -R
$ ~/.arduino15/packages/adafruit/tools/bossac/1.8.0-48-gb176eee/bossac -i -d --port=ttyACM1 -U -i --offset=0x2000 -w -v ./build-artifacts/featherM0/BaremetalReference/bin/BaremetalReference.bin -R

```
Note:
  - If you have other devices connected, or if you are using a different OS, `ttyACM0` and/or `ttyACM1` may differ for your system.

## Using GDS over serial
```
$ fprime-gds -n --dictionary ./build-artifacts/YOUR_DEVICE/BaremetalReference/dict/BaremetalReferenceTopologyAppDictionary.xml --comm-adapter uart --uart-device /dev/ttyACM0 --uart-baud 115200
```
Note:
  - If you have more than one device connected, or if you are using a different OS, `/dev/ttyACM0` may differ for your system.
  - Change `YOUR_DEVICE` to the respective device of the Baremetal Reference. (i.e. `teensy41`, `featherM0`)
