name: baremetal-ci-actions
run-name: ${{ github.actor }} running Baremetal CI actions
on: [push]

env:
  baremetal-bin: ${{ github.workspace }}/build-artifacts/teensy41/BaremetalReference/bin/BaremetalReference.hex
  baremetal-dict: ${{ github.workspace }}/build-artifacts/teensy41/BaremetalReference/dict/BaremetalReferenceTopologyAppDictionary.xml
  upload-addr: usb:3120000
  serial-gds-args: --comm-adapter uart --uart-device /dev/tty.usbmodem159910601
  log-path:  ../test_artifacts/test_run_$(date +'%Y-%m-%dT%H%M%S').txt

jobs:
  build:
    runs-on: self-hosted
    steps:
      - uses: actions/checkout@v4
      - name: "Checkout F' Repository"
        uses: actions/checkout@v4
        with:
          submodules: true
          path: ${{ inputs.fprime_location }}
      - name: "Build"
        run: |
             python3 -m venv ./fprime-venv
             . ./fprime-venv/bin/activate
             pip3 install -r ${{ inputs.fprime_location }}./fprime/requirements.txt
             curl -fsSL https://raw.githubusercontent.com/arduino/arduino-cli/master/install.sh | BINDIR=. sh
             git clone https://github.com/SterlingPeet/arduino-cli-cmake-wrapper.git
             cd arduino-cli-cmake-wrapper
             git checkout update/refactor
             pip install .
             cd ..
             fprime-util generate
             fprime-util build
      - name: "Temp step, file renaming"
        run: |
             mv ${{ github.workspace }}/lib/arduino/fprime-arduino/ATmega/vendor/libraries/TimerOne/examples/FanSpeed/FanSpeed.pde ${{ github.workspace }}/lib/arduino/fprime-arduino/ATmega/vendor/libraries/TimerOne/examples/FanSpeed/FanSpeed.ino
             mv ${{ github.workspace }}/lib/arduino/fprime-arduino/ATmega/vendor/libraries/TimerOne/examples/Interrupt/Interrupt.pde ${{ github.workspace }}/lib/arduino/fprime-arduino/ATmega/vendor/libraries/TimerOne/examples/Interrupt/Interrupt.ino
  upload:
    runs-on: self-hosted
    needs: build
    steps:
      - name: "Load FSW onto Teensy41"
        run: arduino-cli upload --fqbn teensy:avr:teensy41 -p ${{ env.upload-addr }} -i ${{ env.baremetal-bin }}
  gds:
    runs-on: self-hosted
    needs: [build, upload]
    steps:
      - name: "Start GDS"
        run: fprime-gds -n --dictionary ${{ env.baremetal-dict }} --gui none ${{ env.serial-gds-args }} &
  fit:
    runs-on: self-hosted
    needs: [build, upload, gds]
    steps:
      - name: "Run Integration tests"
        run: |
            sleep 13
            pytest BaremetalReference/test/int/baremetal_ref_integration_test.py --dictionary ${{ env.baremetal-dict }} -rP | tee ${{ env.log-path }}
